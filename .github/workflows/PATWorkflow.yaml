name: Sequential Jobs with Auto-Approve via PAT

on:
  workflow_dispatch:

jobs:
  # -----------------------------
  # Job 1: Manual approval
  # -----------------------------
  job1:
    environment: test   # ðŸ”’ requires manual approval
    runs-on: ubuntu-latest
    steps:
      - name: Job1 - Manual approval step
        run: |
          echo "Job1 running after manual approval"

  # -----------------------------
  # Job 2: Actual work, waits for approval
  # -----------------------------
  job2:
    needs: job1
    environment: test   # Still protected
    runs-on: ubuntu-latest
    steps:
      - name: Job2 main step
        run: echo "Job2 running after auto-approval by Job3"
  
  job2_1:
    needs: job1
    environment: test   # Still protected
    runs-on: ubuntu-latest
    steps:
      - name: Job2 main step
        run: echo "Job2 running after auto-approval by Job3"


  # -----------------------------
  # Job 3: PAT auto-approve for Job2
  # -----------------------------
  job3:
    needs: job2_1
    runs-on: ubuntu-latest
    steps:
      - name: Auto-approve Job2 environment
        env:
          REPO_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "Waiting 10 seconds to ensure Job2 is pending approval..."
          # sleep 20    wait 10 seconds (adjust as needed)
          echo "Job3: Auto-approving environment look for aprovals"

          # Get environment ID
          ENV_ID=$(curl -s -H "Authorization: Bearer $REPO_TOKEN" \
            https://api.github.com/repos/${{ github.repository }}/environments \
            | jq '.environments[] | select(.name=="test") | .id')

          echo " the workflow id is  direct reference $ENV_ID"
      
          echo " the repository is "${{ github.repository }} "

          # Approve all pending deployments for this workflow run
          curl -s -X POST \
            -H "Authorization: Bearer $REPO_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"environment_ids\":[$ENV_ID],\"state\":\"approved\",\"comment\":\"Auto-approved via PAT\"}" \
            https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/pending_deployments

            echo " the repository is "${{ github.repository }}"

  job4:
    needs: job2
    environment: test 
    runs-on: ubuntu-latest
    steps:
     - name: Job2 main step
       run: echo "Job4 running after auto-approval by Job6"  
       
  job5:
    needs: job2
    environment: test 
    runs-on: ubuntu-latest
    steps:
     - name: Job2 main step
       run: echo "Job4 running after auto-approval by Job6"  
    
  job6:
    needs: job2
    runs-on: ubuntu-latest
    steps:
      - name: Auto-approve Job2 environment
        env:
          REPO_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "Waiting 10 seconds to ensure Job2 is pending approval..."
          # sleep 20    wait 10 seconds (adjust as needed)
          echo "Job3: Auto-approving environment look for aprovals"

          # Get environment ID
          ENV_ID=$(curl -s -H "Authorization: Bearer $REPO_TOKEN" \
            https://api.github.com/repos/${{ github.repository }}/environments \
            | jq '.environments[] | select(.name=="test") | .id')

          echo " the workflow id is  direct reference $ENV_ID"
      
          echo " the repository is "${{ github.repository }} "

          # Approve all pending deployments for this workflow run
          curl -s -X POST \
            -H "Authorization: Bearer $REPO_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"environment_ids\":[$ENV_ID],\"state\":\"approved\",\"comment\":\"Auto-approved via PAT\"}" \
            https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/pending_deployments

            echo " the repository is "${{ github.repository }}"
    
            
    
